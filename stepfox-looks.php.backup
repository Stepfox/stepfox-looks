<?php
/**
 * Plugin Name: Stepfox Looks
 * Plugin URI: https://stepfoxthemes.com/plugins/stepfox-looks
 * Description: Comprehensive block editor enhancements and responsive controls for Stepfox themes. Includes custom blocks, responsive extensions, and advanced styling options.
 * Version: 1.0.0
 * Author: Stepfox
 * Author URI: https://stepfoxthemes.com
 * Text Domain: stepfox-looks
 * Domain Path: /languages
 * Requires at least: 6.0
 * Tested up to: 6.7
 * Requires PHP: 7.4
 * License: GPL v2 or later
 * License URI: https://www.gnu.org/licenses/gpl-2.0.html
 */

// Prevent direct access
if (!defined('ABSPATH')) {
    exit;
}
// Debug: Check if plugin is loading
error_log('STEPFOX LOOKS PLUGIN: Loading at ' . date('Y-m-d H:i:s'));


// Define plugin constants
if (!defined('STEPFOX_LOOKS_VERSION')) {
    define('STEPFOX_LOOKS_VERSION', '1.0.0');
}

if (!defined('STEPFOX_LOOKS_PATH')) {
    define('STEPFOX_LOOKS_PATH', plugin_dir_path(__FILE__));
}

if (!defined('STEPFOX_LOOKS_URL')) {
    define('STEPFOX_LOOKS_URL', plugin_dir_url(__FILE__));
}

/**
 * Main Stepfox Looks Plugin Class
 */
class Stepfox_Looks_Plugin {
    
    /**
     * Initialize the plugin
     */
    public static function init() {
        // Load text domain
        add_action('init', array(__CLASS__, 'load_textdomain'));
        
        // Enqueue assets
        add_action('enqueue_block_editor_assets', array(__CLASS__, 'enqueue_editor_assets'));
        add_action('wp_enqueue_scripts', array(__CLASS__, 'enqueue_frontend_assets'));
        
        // Register block attributes and categories
        add_action('wp_loaded', array(__CLASS__, 'register_block_attributes'), 100);
        add_filter('block_categories_all', array(__CLASS__, 'register_block_category'), 10, 2);
        
        // Load components
        add_action('init', array(__CLASS__, 'load_components'));
    }
    
    /**
     * Load plugin text domain for translations
     */
    public static function load_textdomain() {
        load_plugin_textdomain('stepfox-looks', false, dirname(plugin_basename(__FILE__)) . '/languages');
    }
    
    /**
     * Enqueue editor assets
     */
    public static function enqueue_editor_assets() {
        // This can be used to enqueue global editor assets if needed
        // Currently handled by individual blocks and extensions
    }

    /**
     * Enqueue frontend assets
     */
    public static function enqueue_frontend_assets() {
        // Frontend styles will be added here when needed
    }
    
    /**
     * Register block attributes for all blocks
     */
    public static function register_block_attributes() {
        $registered_blocks = WP_Block_Type_Registry::get_instance()->get_all_registered();

        foreach ($registered_blocks as $name => $block) {
            // Core responsive attributes
            $block->attributes['resolution'] = ["type" => "string", "default" => "desktop"];
            $block->attributes['element_state'] = ["type" => "string", "default" => "normal"];

            // Layout attributes
            $block->attributes['position'] = ["type" => "object", "default" => ['desktop' => '', 'tablet' => '', 'mobile' => '']];
            $block->attributes['display'] = ["type" => "object", "default" => ['desktop' => '', 'tablet' => '', 'mobile' => '']];
            $block->attributes['flex_wrap'] = ["type" => "object", "default" => ['desktop' => '', 'tablet' => '', 'mobile' => '']];
            $block->attributes['flex_direction'] = ["type" => "object", "default" => ['desktop' => '', 'tablet' => '', 'mobile' => '']];
            
            // Main plugin toggle
            $block->attributes['stepfox_looks'] = ["type" => "object", "default" => ['toggle' => true, 'toggle2' => true]];
        }
    }
    
    /**
     * Register custom block category
     */
    public static function register_block_category($categories, $post) {
        return array_merge($categories, array(
        error_log("STEPFOX DEBUG: Registering examiner block category");
            array(
                'slug'  => 'examiner',
                'title' => __('Examiner Blocks', 'stepfox-looks'),
                'icon'  => 'admin-customizer',
            ),
        ));
    }
    
    /**
     * Load all plugin components
     */
    public static function load_components() {
        // Load blocks
        self::load_blocks();
        
        // Load extensions
        self::load_extensions();
    }
    
    /**
     * Load custom blocks
     */
    public static function load_blocks() {
        $blocks_path = STEPFOX_LOOKS_PATH . 'blocks/';
        
        // Load metafield block
        if (file_exists($blocks_path . 'metafield-block/metafield_block.php')) {
            require_once $blocks_path . 'metafield-block/metafield_block.php';
        }
        
        // Load load-more block
        if (file_exists($blocks_path . 'load-more/load-more.php')) {
            require_once $blocks_path . 'load-more/load-more.php';
        }
    }
    
    /**
     * Load extensions
     */
    public static function load_extensions() {
        $extensions_path = STEPFOX_LOOKS_PATH . 'extensions/';
        
        // Load responsive extension
        if (file_exists($extensions_path . 'responsive/responsive.php')) {
            require_once $extensions_path . 'responsive/responsive.php';
        }
        
        // Load social share extension
        if (file_exists($extensions_path . 'social-share/social-share.php')) {
            require_once $extensions_path . 'social-share/social-share.php';
        }
        
        // Load post template fallback
        if (file_exists($extensions_path . 'post-template-fallback/post-template-fallback.php')) {
            require_once $extensions_path . 'post-template-fallback/post-template-fallback.php';
        }
        
        // Load cover block extension
        if (file_exists($extensions_path . 'cover-block-extension/cover-block-extension.php')) {
            require_once $extensions_path . 'cover-block-extension/cover-block-extension.php';
        }
    }
}

// Initialize the plugin
Stepfox_Looks_Plugin::init();

// Activation hook
register_activation_hook(__FILE__, function() {
    // Flush rewrite rules on activation
    flush_rewrite_rules();
});

// Deactivation hook
register_deactivation_hook(__FILE__, function() {
    // Clean up on deactivation
    flush_rewrite_rules();
});
